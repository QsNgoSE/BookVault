<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookVault API Test Suite</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
        .test-result {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid;
        }
        .test-success {
            background-color: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .test-fail {
            background-color: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .test-running {
            background-color: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        .test-pending {
            background-color: #e2e3e5;
            border-left-color: #6c757d;
            color: #383d41;
        }
        .response-data {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .test-section {
            margin-bottom: 30px;
        }
        .service-status {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
        }
        .status-online {
            background-color: #28a745;
            color: white;
        }
        .status-offline {
            background-color: #dc3545;
            color: white;
        }
        .status-checking {
            background-color: #ffc107;
            color: black;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">📡 BookVault API Test Suite</h1>
                
                <!-- Service Status -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3><i class="bi bi-server"></i> Service Status</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>Auth Service:</span>
                                    <span class="service-status status-checking" id="auth-status">Checking...</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>Book Service:</span>
                                    <span class="service-status status-checking" id="book-status">Checking...</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>Database:</span>
                                    <span class="service-status status-checking" id="db-status">Checking...</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>Redis:</span>
                                    <span class="service-status status-checking" id="redis-status">Checking...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Controls -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3><i class="bi bi-play-circle"></i> Test Controls</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <button class="btn btn-primary w-100" id="runAllTests">
                                    <i class="bi bi-play-fill"></i> Run All Tests
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-secondary w-100" id="clearResults">
                                    <i class="bi bi-trash"></i> Clear Results
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-info w-100" id="exportResults">
                                    <i class="bi bi-download"></i> Export Results
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Results Summary -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3><i class="bi bi-graph-up"></i> Test Summary</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h4 text-success" id="passedCount">0</div>
                                    <div class="text-muted">Passed</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h4 text-danger" id="failedCount">0</div>
                                    <div class="text-muted">Failed</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h4 text-warning" id="runningCount">0</div>
                                    <div class="text-muted">Running</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h4 text-secondary" id="totalCount">0</div>
                                    <div class="text-muted">Total</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Results -->
                <div class="accordion" id="testAccordion">
                    <!-- Auth Service Tests -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#authTests">
                                <i class="bi bi-shield-lock me-2"></i> Auth Service Tests
                            </button>
                        </h2>
                        <div id="authTests" class="accordion-collapse collapse show" data-bs-parent="#testAccordion">
                            <div class="accordion-body">
                                <div id="authTestResults"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Book Service Tests -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#bookTests">
                                <i class="bi bi-book me-2"></i> Book Service Tests
                            </button>
                        </h2>
                        <div id="bookTests" class="accordion-collapse collapse" data-bs-parent="#testAccordion">
                            <div class="accordion-body">
                                <div id="bookTestResults"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Service Tests -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#orderTests">
                                <i class="bi bi-cart me-2"></i> Order Service Tests
                            </button>
                        </h2>
                        <div id="orderTests" class="accordion-collapse collapse" data-bs-parent="#testAccordion">
                            <div class="accordion-body">
                                <div id="orderTestResults"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Service Tests -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#adminTests">
                                <i class="bi bi-gear me-2"></i> Admin Service Tests
                            </button>
                        </h2>
                        <div id="adminTests" class="accordion-collapse collapse" data-bs-parent="#testAccordion">
                            <div class="accordion-body">
                                <div id="adminTestResults"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Test Configuration
        const TEST_CONFIG = {
            AUTH_SERVICE_URL: 'http://localhost:8082/api',
            BOOK_SERVICE_URL: 'http://localhost:8083/api',
            TEST_USER: {
                email: 'test@example.com',
                password: 'Test123!',
                firstName: 'Test',
                lastName: 'User'
            },
            TEST_ADMIN: {
                email: 'admin@example.com',
                password: 'Admin123!'
            }
        };

        // Test state
        let testResults = [];
        let authToken = null;
        let adminToken = null;
        let testUserId = null;
        let testBookId = null;
        let testOrderId = null;

        // Initialize test suite
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🧪 Initializing API Test Suite...');
            
            // Check service status
            checkServiceStatus();
            
            // Set up event listeners
            document.getElementById('runAllTests').addEventListener('click', runAllTests);
            document.getElementById('clearResults').addEventListener('click', clearResults);
            document.getElementById('exportResults').addEventListener('click', exportResults);
            
            updateTestSummary();
        });

        // Service Status Check
        async function checkServiceStatus() {
            console.log('🔍 Checking service status...');
            
            // Check Auth Service
            try {
                const authResponse = await fetch(`${TEST_CONFIG.AUTH_SERVICE_URL}/auth/health`);
                updateServiceStatus('auth-status', authResponse.ok);
            } catch (error) {
                updateServiceStatus('auth-status', false);
            }

            // Check Book Service
            try {
                const bookResponse = await fetch(`${TEST_CONFIG.BOOK_SERVICE_URL}/books/health`);
                updateServiceStatus('book-status', bookResponse.ok);
            } catch (error) {
                updateServiceStatus('book-status', false);
            }

            // Database and Redis status will be checked through service health endpoints
            updateServiceStatus('db-status', true); // Will be verified through actual API calls
            updateServiceStatus('redis-status', true); // Will be verified through actual API calls
        }

        function updateServiceStatus(elementId, isOnline) {
            const element = document.getElementById(elementId);
            if (isOnline) {
                element.className = 'service-status status-online';
                element.textContent = 'Online';
            } else {
                element.className = 'service-status status-offline';
                element.textContent = 'Offline';
            }
        }

        // Main test runner
        async function runAllTests() {
            console.log('🚀 Starting comprehensive API tests...');
            clearResults();
            
            // Run tests in sequence
            await runAuthTests();
            await runBookTests();
            await runOrderTests();
            await runAdminTests();
            
            console.log('✅ All tests completed!');
            updateTestSummary();
        }

        // Auth Service Tests
        async function runAuthTests() {
            console.log('🔐 Running Auth Service Tests...');
            
            // Test 1: User Registration
            await runTest('auth', 'User Registration', async () => {
                const response = await fetch(`${TEST_CONFIG.AUTH_SERVICE_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: TEST_CONFIG.TEST_USER.email,
                        password: TEST_CONFIG.TEST_USER.password,
                        firstName: TEST_CONFIG.TEST_USER.firstName,
                        lastName: TEST_CONFIG.TEST_USER.lastName
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    testUserId = data.userId || data.id;
                    return { success: true, data };
                } else if (response.status === 400 && data.message?.includes('already exists')) {
                    // User already exists, that's fine for testing
                    return { success: true, data: { message: 'User already exists (expected)' } };
                } else {
                    return { success: false, data, error: data.message || 'Registration failed' };
                }
            });

            // Test 2: User Login
            await runTest('auth', 'User Login', async () => {
                const response = await fetch(`${TEST_CONFIG.AUTH_SERVICE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: TEST_CONFIG.TEST_USER.email,
                        password: TEST_CONFIG.TEST_USER.password
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.token) {
                    authToken = data.token;
                    testUserId = data.userId || data.id;
                    return { success: true, data };
                } else {
                    return { success: false, data, error: data.message || 'Login failed' };
                }
            });

            // Test 3: Get User Profile
            await runTest('auth', 'Get User Profile', async () => {
                if (!authToken) {
                    return { success: false, error: 'No auth token available' };
                }
                
                const response = await fetch(`${TEST_CONFIG.AUTH_SERVICE_URL}/auth/profile`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    return { success: true, data };
                } else {
                    return { success: false, data, error: data.message || 'Profile fetch failed' };
                }
            });

            // Test 4: Update User Profile
            await runTest('auth', 'Update User Profile', async () => {
                if (!authToken) {
                    return { success: false, error: 'No auth token available' };
                }
                
                const response = await fetch(`${TEST_CONFIG.AUTH_SERVICE_URL}/auth/profile`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        firstName: 'Updated',
                        lastName: 'User'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return { success: true, data };
                } else {
                    const data = await response.json();
                    return { success: false, data, error: data.message || 'Profile update failed' };
                }
            });

            // Test 5: Admin Login (if admin exists)
            await runTest('auth', 'Admin Login', async () => {
                const response = await fetch(`${TEST_CONFIG.AUTH_SERVICE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: TEST_CONFIG.TEST_ADMIN.email,
                        password: TEST_CONFIG.TEST_ADMIN.password
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.token) {
                    adminToken = data.token;
                    return { success: true, data };
                } else {
                    return { success: false, data, error: data.message || 'Admin login failed (admin might not exist)' };
                }
            });
        }

        // Book Service Tests
        async function runBookTests() {
            console.log('📚 Running Book Service Tests...');
            
            // Test 1: Get All Books
            await runTest('book', 'Get All Books', async () => {
                const response = await fetch(`${TEST_CONFIG.BOOK_SERVICE_URL}/books`);
                const data = await response.json();
                
                if (response.ok) {
                    if (Array.isArray(data.content) && data.content.length > 0) {
                        testBookId = data.content[0].id;
                    }
                    return { success: true, data };
                } else {
                    return { success: false, data, error: data.message || 'Failed to fetch books' };
                }
            });

            // Test 2: Get Book Categories
            await runTest('book', 'Get Book Categories', async () => {
                const response = await fetch(`${TEST_CONFIG.BOOK_SERVICE_URL}/books/categories`);
                const data = await response.json();
                
                if (response.ok) {
                    return { success: true, data };
                } else {
                    return { success: false, data, error: data.message || 'Failed to fetch categories' };
                }
            });

            // Test 3: Search Books
            await runTest('book', 'Search Books', async () => {
                const response = await fetch(`${TEST_CONFIG.BOOK_SERVICE_URL}/books/search?q=book`);
                const data = await response.json();
                
                if (response.ok) {
                    return { success: true, data };
                } else {
                    return { success: false, data, error: data.message || 'Search failed' };
                }
            });

            // Test 4: Get Book by ID
            await runTest('book', 'Get Book by ID', async () => {
                if (!testBookId) {
                    return { success: false, error: 'No book ID available for testing' };
                }
                
                const response = await fetch(`${TEST_CONFIG.BOOK_SERVICE_URL}/books/${testBookId}`);
                const data = await response.json();
                
                if (response.ok) {
                    return { success: true, data };
                } else {
                    return { success: false, data, error: data.message || 'Failed to fetch book' };
                }
            });

            // Test 5: Create Book (Admin only)
            await runTest('book', 'Create Book (Admin)', async () => {
                if (!adminToken) {
                    return { success: false, error: 'No admin token available' };
                }
                
                const response = await fetch(`${TEST_CONFIG.BOOK_SERVICE_URL}/books`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: 'Test Book',
                        author: 'Test Author',
                        isbn: '978-0-000-00000-0',
                        price: 19.99,
                        stockQuantity: 10,
                        description: 'A test book for API testing',
                        categoryId: 1
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return { success: true, data };
                } else {
                    const data = await response.json();
                    return { success: false, data, error: data.message || 'Failed to create book' };
                }
            });
        }

        // Order Service Tests
        async function runOrderTests() {
            console.log('🛒 Running Order Service Tests...');
            
            // Test 1: Create Order
            await runTest('order', 'Create Order', async () => {
                if (!authToken || !testBookId) {
                    return { success: false, error: 'Missing auth token or book ID' };
                }
                
                const response = await fetch(`${TEST_CONFIG.BOOK_SERVICE_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        items: [{
                            bookId: testBookId,
                            quantity: 1,
                            unitPrice: 19.99
                        }],
                        shippingAddress: '123 Test St',
                        shippingCity: 'Test City',
                        shippingState: 'TS',
                        shippingPostalCode: '12345',
                        shippingCountry: 'United States',
                        paymentMethod: 'CREDIT_CARD',
                        customerEmail: TEST_CONFIG.TEST_USER.email,
                        customerName: `${TEST_CONFIG.TEST_USER.firstName} ${TEST_CONFIG.TEST_USER.lastName}`
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    testOrderId = data.id;
                    return { success: true, data };
                } else {
                    const data = await response.json();
                    return { success: false, data, error: data.message || 'Failed to create order' };
                }
            });

            // Test 2: Get User Orders
            await runTest('order', 'Get User Orders', async () => {
                if (!authToken) {
                    return { success: false, error: 'No auth token available' };
                }
                
                const response = await fetch(`${TEST_CONFIG.BOOK_SERVICE_URL}/orders/my-orders`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return { success: true, data };
                } else {
                    const data = await response.json();
                    return { success: false, data, error: data.message || 'Failed to fetch orders' };
                }
            });

            // Test 3: Get Order by ID
            await runTest('order', 'Get Order by ID', async () => {
                if (!authToken || !testOrderId) {
                    return { success: false, error: 'Missing auth token or order ID' };
                }
                
                const response = await fetch(`${TEST_CONFIG.BOOK_SERVICE_URL}/orders/${testOrderId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return { success: true, data };
                } else {
                    const data = await response.json();
                    return { success: false, data, error: data.message || 'Failed to fetch order' };
                }
            });

            // Test 4: Update Order Status (Admin)
            await runTest('order', 'Update Order Status (Admin)', async () => {
                if (!adminToken || !testOrderId) {
                    return { success: false, error: 'Missing admin token or order ID' };
                }
                
                const response = await fetch(`${TEST_CONFIG.BOOK_SERVICE_URL}/orders/${testOrderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'CONFIRMED' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return { success: true, data };
                } else {
                    const data = await response.json();
                    return { success: false, data, error: data.message || 'Failed to update order status' };
                }
            });

            // Test 5: Cancel Order
            await runTest('order', 'Cancel Order', async () => {
                if (!authToken || !testOrderId) {
                    return { success: false, error: 'Missing auth token or order ID' };
                }
                
                const response = await fetch(`${TEST_CONFIG.BOOK_SERVICE_URL}/orders/${testOrderId}/cancel`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason: 'API Test Cancellation' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return { success: true, data };
                } else {
                    const data = await response.json();
                    return { success: false, data, error: data.message || 'Failed to cancel order' };
                }
            });
        }

        // Admin Service Tests
        async function runAdminTests() {
            console.log('⚙️ Running Admin Service Tests...');
            
            // Test 1: Get All Users (Admin)
            await runTest('admin', 'Get All Users', async () => {
                if (!adminToken) {
                    return { success: false, error: 'No admin token available' };
                }
                
                const response = await fetch(`${TEST_CONFIG.AUTH_SERVICE_URL}/auth/admin/users`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return { success: true, data };
                } else {
                    const data = await response.json();
                    return { success: false, data, error: data.message || 'Failed to fetch users' };
                }
            });

            // Test 2: Get Admin Dashboard Stats
            await runTest('admin', 'Get Dashboard Stats', async () => {
                if (!adminToken) {
                    return { success: false, error: 'No admin token available' };
                }
                
                const response = await fetch(`${TEST_CONFIG.AUTH_SERVICE_URL}/auth/admin/dashboard/stats`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return { success: true, data };
                } else {
                    const data = await response.json();
                    return { success: false, data, error: data.message || 'Failed to fetch stats' };
                }
            });

            // Test 3: Get All Orders (Admin)
            await runTest('admin', 'Get All Orders', async () => {
                if (!adminToken) {
                    return { success: false, error: 'No admin token available' };
                }
                
                const response = await fetch(`${TEST_CONFIG.BOOK_SERVICE_URL}/orders/admin/all`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return { success: true, data };
                } else {
                    const data = await response.json();
                    return { success: false, data, error: data.message || 'Failed to fetch orders' };
                }
            });
        }

        // Test runner helper
        async function runTest(category, testName, testFunction) {
            const testId = `${category}-${testName.replace(/\s+/g, '-').toLowerCase()}`;
            
            // Add test to results
            const testResult = {
                id: testId,
                category: category,
                name: testName,
                status: 'running',
                startTime: new Date(),
                endTime: null,
                duration: null,
                result: null,
                error: null
            };
            
            testResults.push(testResult);
            displayTestResult(testResult);
            updateTestSummary();
            
            try {
                console.log(`🧪 Running test: ${testName}`);
                const result = await testFunction();
                
                testResult.status = result.success ? 'passed' : 'failed';
                testResult.result = result.data;
                testResult.error = result.error;
                testResult.endTime = new Date();
                testResult.duration = testResult.endTime - testResult.startTime;
                
                console.log(`${result.success ? '✅' : '❌'} ${testName}: ${result.success ? 'PASSED' : 'FAILED'}`);
                if (result.error) {
                    console.log(`   Error: ${result.error}`);
                }
                
            } catch (error) {
                testResult.status = 'failed';
                testResult.error = error.message;
                testResult.endTime = new Date();
                testResult.duration = testResult.endTime - testResult.startTime;
                
                console.log(`❌ ${testName}: FAILED with exception`);
                console.log(`   Error: ${error.message}`);
            }
            
            displayTestResult(testResult);
            updateTestSummary();
        }

        // Display test result
        function displayTestResult(testResult) {
            const container = document.getElementById(`${testResult.category}TestResults`);
            const existingElement = document.getElementById(testResult.id);
            
            let statusClass = 'test-pending';
            let statusIcon = '⏳';
            let statusText = 'Pending';
            
            if (testResult.status === 'running') {
                statusClass = 'test-running';
                statusIcon = '🔄';
                statusText = 'Running';
            } else if (testResult.status === 'passed') {
                statusClass = 'test-success';
                statusIcon = '✅';
                statusText = 'Passed';
            } else if (testResult.status === 'failed') {
                statusClass = 'test-fail';
                statusIcon = '❌';
                statusText = 'Failed';
            }
            
            const html = `
                <div class="test-result ${statusClass}" id="${testResult.id}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${statusIcon} ${testResult.name}</strong>
                            <div class="small text-muted">
                                Status: ${statusText}
                                ${testResult.duration ? ` | Duration: ${testResult.duration}ms` : ''}
                                ${testResult.endTime ? ` | Completed: ${testResult.endTime.toLocaleTimeString()}` : ''}
                            </div>
                        </div>
                        <div>
                            ${testResult.error ? `<span class="text-danger">${testResult.error}</span>` : ''}
                        </div>
                    </div>
                    ${testResult.result ? `
                        <div class="response-data">
                            <strong>Response:</strong><br>
                            ${JSON.stringify(testResult.result, null, 2)}
                        </div>
                    ` : ''}
                </div>
            `;
            
            if (existingElement) {
                existingElement.outerHTML = html;
            } else {
                container.innerHTML += html;
            }
        }

        // Update test summary
        function updateTestSummary() {
            const passed = testResults.filter(t => t.status === 'passed').length;
            const failed = testResults.filter(t => t.status === 'failed').length;
            const running = testResults.filter(t => t.status === 'running').length;
            const total = testResults.length;
            
            document.getElementById('passedCount').textContent = passed;
            document.getElementById('failedCount').textContent = failed;
            document.getElementById('runningCount').textContent = running;
            document.getElementById('totalCount').textContent = total;
        }

        // Clear results
        function clearResults() {
            testResults = [];
            document.getElementById('authTestResults').innerHTML = '';
            document.getElementById('bookTestResults').innerHTML = '';
            document.getElementById('orderTestResults').innerHTML = '';
            document.getElementById('adminTestResults').innerHTML = '';
            updateTestSummary();
        }

        // Export results
        function exportResults() {
            const results = {
                timestamp: new Date().toISOString(),
                summary: {
                    total: testResults.length,
                    passed: testResults.filter(t => t.status === 'passed').length,
                    failed: testResults.filter(t => t.status === 'failed').length,
                    running: testResults.filter(t => t.status === 'running').length
                },
                tests: testResults
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bookvault-api-test-results-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html> 